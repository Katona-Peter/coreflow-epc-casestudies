name: ğŸ”’ Security Check - DEBUG Setting

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  debug-check:
    name: ğŸ” Check Django DEBUG Setting
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: ğŸ” Check DEBUG setting in Django settings
      run: |
        echo "ğŸ” Scanning for Django settings files..."
        
        # Find all settings.py files (excluding virtual environments)
        SETTINGS_FILES=$(find . -name "settings.py" -not -path "./.venv/*" -not -path "./venv/*" -not -path "./.git/*" 2>/dev/null || true)
        
        if [ -z "$SETTINGS_FILES" ]; then
          echo "â„¹ï¸  No Django settings.py files found."
          exit 0
        fi
        
        echo "ğŸ“„ Found settings files:"
        for file in $SETTINGS_FILES; do
          echo "   â€¢ $file"
        done
        echo ""
        
        # Check each settings file
        DEBUG_FOUND=false
        for SETTINGS_FILE in $SETTINGS_FILES; do
          echo "ğŸ” Checking: $SETTINGS_FILE"
          
          # Check for DEBUG = True (with various whitespace patterns)
          if grep -E "^\s*DEBUG\s*=\s*True" "$SETTINGS_FILE" 2>/dev/null; then
            echo "âŒ ERROR: DEBUG=True found in $SETTINGS_FILE"
            echo "   Line: $(grep -n "DEBUG.*True" "$SETTINGS_FILE" 2>/dev/null || echo "Line not found")"
            DEBUG_FOUND=true
          fi
          
          # Also check for DEBUG=1 or other truthy values
          if grep -E "^\s*DEBUG\s*=\s*[1-9]" "$SETTINGS_FILE" 2>/dev/null; then
            echo "âŒ ERROR: DEBUG set to truthy value in $SETTINGS_FILE"
            echo "   Line: $(grep -n "DEBUG.*[1-9]" "$SETTINGS_FILE" 2>/dev/null || echo "Line not found")"
            DEBUG_FOUND=true
          fi
          
          # Check for DEBUG = False
          if grep -E "^\s*DEBUG\s*=\s*False" "$SETTINGS_FILE" 2>/dev/null; then
            echo "   âœ… DEBUG=False (OK)"
          elif grep -E "^\s*DEBUG\s*=" "$SETTINGS_FILE" 2>/dev/null; then
            echo "   âš ï¸  DEBUG setting found but not explicitly False"
            # Get the actual DEBUG line
            DEBUG_LINE=$(grep -E "^\s*DEBUG\s*=" "$SETTINGS_FILE" 2>/dev/null)
            echo "   Line: $DEBUG_LINE"
          else
            echo "   âš ï¸  No DEBUG setting found"
          fi
        done
        
        if [ "$DEBUG_FOUND" = true ]; then
          echo ""
          echo "ğŸš« SECURITY VIOLATION DETECTED!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "   DEBUG mode is enabled in Django settings."
          echo "   This is a critical security risk and must be fixed before deployment."
          echo ""
          echo "ğŸ”§ Required fixes:"
          echo "   1. Set DEBUG = False in all settings.py files"
          echo "   2. Use environment variables for DEBUG control:"
          echo "      DEBUG = os.environ.get('DEBUG', 'False').lower() == 'true'"
          echo ""
          echo "ğŸ’¡ For development environments:"
          echo "   â€¢ Use local_settings.py (add to .gitignore)"
          echo "   â€¢ Set DEBUG=True via environment variables locally"
          echo "   â€¢ Use separate settings files for different environments"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1
        fi
        
        echo ""
        echo "ğŸ‰ SECURITY CHECK PASSED!"
        echo "âœ… DEBUG=False confirmed in Django settings files."
        echo "ğŸš€ Safe for production deployment."

    - name: ğŸ“Š Security Summary
      if: success()
      run: |
        echo ""
        echo "ğŸ›¡ï¸  SECURITY CHECK SUMMARY"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ… Django DEBUG setting verification: PASSED"
        echo "âœ… No DEBUG=True found in settings files"
        echo "âœ… Repository is safe for production deployment"
        echo ""
        echo "ğŸ”’ This workflow helps prevent accidental deployment"
        echo "   of Django applications with DEBUG=True enabled."

    - name: ğŸš¨ Security Failure Notification
      if: failure()
      run: |
        echo ""
        echo "ğŸš¨ SECURITY CHECK FAILED!"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âŒ DEBUG=True detected in Django settings"
        echo "âŒ This is a critical security vulnerability"
        echo "âŒ Deployment blocked until resolved"
        echo ""
        echo "ğŸ› ï¸  Please fix the DEBUG setting and try again."
